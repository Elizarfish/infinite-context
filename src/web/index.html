<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Infinite Context</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#09090b;--surface:#18181b;--surface2:#27272a;--border:#3f3f46;--text:#fafafa;--muted:#a1a1aa;--primary:#6366f1;--primary-hover:#4f46e5;--success:#22c55e;--danger:#ef4444;--warning:#f59e0b;--radius:8px;--font:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh;display:flex}
a{color:var(--primary);text-decoration:none}
button{cursor:pointer;font-family:inherit;border:none;border-radius:var(--radius);padding:6px 14px;font-size:13px;transition:all .15s}
input,select{font-family:inherit;background:var(--surface);color:var(--text);border:1px solid var(--border);border-radius:var(--radius);padding:8px 12px;font-size:13px;outline:none;transition:border .15s}
input:focus,select:focus{border-color:var(--primary)}
input[type=range]{padding:0;border:none;background:transparent;height:20px;cursor:pointer;accent-color:var(--primary)}

/* Sidebar */
.sidebar{width:220px;background:var(--surface);border-right:1px solid var(--border);padding:16px 0;display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:10}
.sidebar h1{font-size:15px;padding:0 20px 16px;border-bottom:1px solid var(--border);margin-bottom:8px;font-weight:600;letter-spacing:-.3px}
.sidebar h1 span{color:var(--primary)}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 20px;color:var(--muted);font-size:13px;cursor:pointer;transition:all .15s;user-select:none}
.nav-item:hover{color:var(--text);background:var(--surface2)}
.nav-item.active{color:var(--primary);background:rgba(99,102,241,.1);border-right:2px solid var(--primary)}
.nav-item svg{width:16px;height:16px;flex-shrink:0}
.sidebar-footer{margin-top:auto;padding:12px 20px;border-top:1px solid var(--border)}
.lang-toggle{display:flex;gap:0;border-radius:var(--radius);overflow:hidden;border:1px solid var(--border)}
.lang-btn{flex:1;padding:6px 0;font-size:12px;font-weight:600;text-align:center;background:transparent;color:var(--muted);border-radius:0;transition:all .15s}
.lang-btn.active{background:var(--primary);color:white}
.lang-btn:hover:not(.active){color:var(--text)}

/* Main */
.main{margin-left:220px;flex:1;padding:24px;min-height:100vh}
.page{display:none}.page.active{display:block}
.page-header{display:flex;align-items:center;gap:12px;margin-bottom:20px}
.page-title{font-size:20px;font-weight:600;letter-spacing:-.3px}
.refresh-ind{font-size:11px;color:var(--muted);margin-left:auto}

/* Stat cards */
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;position:relative}
.stat-card .label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px;display:flex;align-items:center;gap:6px}
.stat-card .value{font-size:28px;font-weight:700;letter-spacing:-1px}
.stat-card .sub{font-size:12px;color:var(--muted);margin-top:4px}
.tip-icon{width:14px;height:14px;border-radius:50%;border:1px solid var(--border);display:inline-flex;align-items:center;justify-content:center;font-size:10px;color:var(--muted);cursor:help;flex-shrink:0}

/* Charts */
.chart-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px}
.chart-box{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px}
.chart-box h3{font-size:13px;color:var(--muted);margin-bottom:16px;font-weight:500}
.chart-box svg{max-height:150px}

/* Category bars */
.cat-bars{display:flex;flex-direction:column;gap:8px}
.cat-bar{display:flex;align-items:center;gap:12px;cursor:pointer;padding:2px 0;border-radius:4px;transition:background .15s}
.cat-bar:hover{background:rgba(255,255,255,.03)}
.cat-bar .cat-name{width:100px;font-size:12px;color:var(--muted);text-align:right;flex-shrink:0}
.cat-bar .bar-wrap{flex:1;height:22px;background:var(--surface2);border-radius:4px;overflow:hidden}
.cat-bar .bar-fill{height:100%;border-radius:4px;transition:width .4s;display:flex;align-items:center;padding:0 8px;font-size:11px;color:white;white-space:nowrap;min-width:fit-content}
.cat-bar .bar-count{font-size:12px;color:var(--muted);width:40px;flex-shrink:0;text-align:right}

/* Toolbar */
.toolbar{display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;align-items:center}
.toolbar input[type=text]{flex:1;min-width:200px}
.toolbar select{min-width:120px}

/* Buttons */
.btn{background:var(--primary);color:white;font-weight:500}
.btn:hover{background:var(--primary-hover)}
.btn:disabled{opacity:.4;cursor:default;pointer-events:none}
.btn-danger{background:var(--danger)}.btn-danger:hover{background:#dc2626}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--muted)}
.btn-outline:hover{border-color:var(--primary);color:var(--primary)}
.btn-sm{padding:4px 10px;font-size:12px}

/* Bulk bar */
.bulk-bar{background:var(--surface);border:1px solid var(--primary);border-radius:var(--radius);padding:10px 16px;margin-bottom:12px;display:none;align-items:center;gap:12px;font-size:13px}
.bulk-bar.show{display:flex}

/* Table */
table{width:100%;border-collapse:collapse}
th{font-size:11px;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);text-align:left;padding:10px 12px;border-bottom:1px solid var(--border);cursor:pointer;user-select:none;white-space:nowrap}
th:hover{color:var(--text)}
th.sorted{color:var(--primary)}
th .arrow{font-size:10px;margin-left:2px}
td{padding:10px 12px;border-bottom:1px solid var(--border);font-size:13px;vertical-align:middle}
tr:hover td{background:rgba(255,255,255,.02)}
.chk{width:16px;height:16px;accent-color:var(--primary);cursor:pointer}

/* Badges */
.badge{display:inline-block;padding:2px 8px;border-radius:12px;font-size:11px;font-weight:500}
.badge-architecture{background:#818cf8;color:#c7d2fe}
.badge-decision{background:#f59e0b;color:#fef3c7}
.badge-error{background:#ef4444;color:#fecaca}
.badge-finding{background:#22c55e;color:#bbf7d0}
.badge-file_change{background:#3b82f6;color:#bfdbfe}
.badge-note{background:#71717a;color:#d4d4d8}

/* Score */
.score-bar{width:60px;height:6px;background:var(--surface2);border-radius:3px;overflow:hidden;display:inline-block;vertical-align:middle;margin-right:6px}
.score-fill{height:100%;border-radius:3px}
.content-cell{max-width:420px;min-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;cursor:pointer}
.content-cell:hover{color:var(--primary)}

/* Pagination */
.pagination{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:16px;padding:16px 0}
.pagination button{background:var(--surface);border:1px solid var(--border);color:var(--muted)}
.pagination button:hover:not(:disabled){border-color:var(--primary);color:var(--primary)}
.pagination button:disabled{opacity:.3;cursor:default}
.page-info{font-size:13px;color:var(--muted)}

/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:100}
.modal-overlay.show{display:flex}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:12px;max-width:700px;width:90%;max-height:80vh;overflow-y:auto;padding:24px}
.modal h2{font-size:16px;margin-bottom:16px}
.modal .field{margin-bottom:12px}
.modal .field-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px}
.modal .field-value{font-size:13px;word-break:break-word;line-height:1.5}
.modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:20px;padding-top:16px;border-top:1px solid var(--border)}

/* Session card */
.card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:12px;transition:border-color .15s}
.card:hover{border-color:var(--primary)}
.card-row{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
.session-id{font-family:monospace;font-size:13px;color:var(--primary);word-break:break-all;max-width:100%}
.session-meta{font-size:12px;color:var(--muted);display:flex;gap:16px;flex-wrap:wrap;margin-top:4px}
.session-stats{display:flex;gap:20px;flex-shrink:0}
.session-stats > div{text-align:center}
.session-stats .num{font-size:20px;font-weight:700;line-height:1.2}
.session-stats .lbl{font-size:11px;color:var(--muted)}

/* Config */
.config-section{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:16px}
.config-section h3{font-size:14px;margin-bottom:16px;color:var(--text);font-weight:600}
.cfg-row{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--border)}
.cfg-row:last-child{border-bottom:none}
.cfg-label{width:220px;flex-shrink:0;font-size:13px;color:var(--muted);display:flex;align-items:center;gap:6px}
.cfg-label code{color:var(--primary);font-size:12px}
.cfg-input{display:flex;align-items:center;gap:8px;flex:1}
.cfg-input input[type=number]{width:100px}
.cfg-input input[type=range]{flex:1;max-width:280px}
.cfg-input .range-val{font-size:12px;color:var(--text);width:50px;text-align:right;font-family:monospace}

/* Toast */
.toast{position:fixed;bottom:24px;right:24px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:12px 20px;font-size:13px;z-index:200;transform:translateY(100px);opacity:0;transition:all .3s;pointer-events:none}
.toast.show{transform:translateY(0);opacity:1}
.toast.success{border-color:var(--success)}.toast.danger{border-color:var(--danger)}

/* Tooltip */
#tooltip{position:fixed;background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:8px 12px;font-size:12px;color:var(--text);max-width:300px;line-height:1.5;z-index:300;pointer-events:none;display:none;box-shadow:0 4px 16px rgba(0,0,0,.4)}

/* Confirm dialog */
.confirm-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:150}
.confirm-overlay.show{display:flex}
.confirm-box{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:24px;max-width:420px;width:90%}
.confirm-box h3{font-size:15px;margin-bottom:8px}
.confirm-box p{font-size:13px;color:var(--muted);margin-bottom:20px;line-height:1.5}
.confirm-box .actions{display:flex;gap:8px;justify-content:flex-end}

/* Skeleton loading */
.skeleton{background:linear-gradient(90deg,var(--surface2) 25%,var(--border) 50%,var(--surface2) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;border-radius:var(--radius);height:20px;margin-bottom:8px}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}

/* Onboarding */
.onboard-overlay{position:fixed;inset:0;background:rgba(9,9,11,.92);display:none;align-items:center;justify-content:center;z-index:250}
.onboard-overlay.show{display:flex}
.onboard{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:40px;max-width:520px;width:90%;text-align:center}
.onboard h2{font-size:22px;margin-bottom:8px}
.onboard .sub{color:var(--muted);font-size:14px;margin-bottom:28px}
.onboard .steps{text-align:left;margin-bottom:28px}
.onboard .step{display:flex;gap:12px;margin-bottom:16px;align-items:flex-start}
.onboard .step-num{width:28px;height:28px;border-radius:50%;background:var(--primary);color:white;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;flex-shrink:0}
.onboard .step-text{font-size:13px;color:var(--muted);line-height:1.5}
.onboard .step-text strong{color:var(--text)}
.empty{text-align:center;padding:48px;color:var(--muted)}

/* Projects grid */
.projects-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(380px,1fr));gap:16px}
.project-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;transition:border-color .15s;cursor:pointer;display:flex;flex-direction:column;gap:12px}
.project-card:hover{border-color:var(--primary)}
.project-card .proj-name{font-size:15px;font-weight:600;word-break:break-word;line-height:1.3}
.project-card .proj-path{font-size:11px;color:var(--muted);font-family:monospace;word-break:break-all;line-height:1.4;max-height:32px;overflow:hidden}
.project-card .proj-footer{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-top:auto}
.project-card .proj-footer select{font-size:12px;padding:4px 8px;max-width:200px}
.project-card .proj-count{margin-left:auto;text-align:right;flex-shrink:0}
.project-card .proj-count .num{font-size:24px;font-weight:700;line-height:1}
.project-card .proj-count .lbl{font-size:11px;color:var(--muted)}

@media(max-width:768px){
  .sidebar{width:56px}.sidebar h1,.nav-item span,.sidebar-footer{display:none}
  .nav-item{justify-content:center;padding:12px}
  .main{margin-left:56px;padding:16px}
  .stats-grid{grid-template-columns:1fr 1fr}
  .chart-row{grid-template-columns:1fr}
  .toolbar{flex-direction:column}.toolbar input[type=text]{min-width:0;width:100%}
  .cfg-row{flex-direction:column;align-items:flex-start}.cfg-label{width:auto}
  .projects-grid{grid-template-columns:1fr}
  .project-card .proj-footer{gap:8px}
  .session-stats{gap:12px}
  table{font-size:12px}
  .content-cell{min-width:120px;max-width:200px}
}
</style>
</head>
<body>
<nav class="sidebar">
  <h1><span>&infin;</span> Context</h1>
  <div class="nav-item active" data-page="overview">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
    <span data-i18n="nav.overview">Overview</span>
  </div>
  <div class="nav-item" data-page="memories">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 100 20 10 10 0 000-20z"/><path d="M12 6v6l4 2"/></svg>
    <span data-i18n="nav.memories">Memories</span>
  </div>
  <div class="nav-item" data-page="projects">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 01-2 2H4a2 2 0 01-2-2V5a2 2 0 012-2h5l2 3h9a2 2 0 012 2z"/></svg>
    <span data-i18n="nav.projects">Projects</span>
  </div>
  <div class="nav-item" data-page="sessions">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
    <span data-i18n="nav.sessions">Sessions</span>
  </div>
  <div class="nav-item" data-page="config">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
    <span data-i18n="nav.config">Settings</span>
  </div>
  <div class="sidebar-footer">
    <div class="lang-toggle">
      <button class="lang-btn active" data-lang="en">EN</button>
      <button class="lang-btn" data-lang="ru">RU</button>
    </div>
  </div>
</nav>

<div class="main">
  <!-- Overview -->
  <div id="page-overview" class="page active">
    <div class="page-header">
      <h2 class="page-title" data-i18n="nav.overview">Overview</h2>
      <span class="refresh-ind" id="last-refresh"></span>
    </div>
    <div class="stats-grid" id="stats-grid"></div>
    <div class="chart-row">
      <div class="chart-box"><h3 data-i18n="overview.scoreDist">Score Distribution</h3><div id="score-chart"></div></div>
      <div class="chart-box"><h3 data-i18n="overview.activity">Activity (30 days)</h3><div id="timeline-chart"></div></div>
    </div>
    <div class="chart-box" style="margin-bottom:24px"><h3 data-i18n="overview.catDist">Category Distribution</h3><div class="cat-bars" id="cat-bars"></div></div>
    <h3 style="font-size:14px;margin-bottom:12px;color:var(--muted)" data-i18n="overview.recentSessions">Recent Sessions</h3>
    <div id="recent-sessions"></div>
  </div>

  <!-- Memories -->
  <div id="page-memories" class="page">
    <div class="page-header"><h2 class="page-title" data-i18n="nav.memories">Memories</h2></div>
    <div class="toolbar">
      <input type="text" id="mem-search" data-i18n-placeholder="mem.searchPlaceholder" placeholder="Search memories...">
      <select id="mem-project"><option value="" data-i18n="mem.allProjects">All Projects</option></select>
      <select id="mem-category">
        <option value="" data-i18n="mem.allCategories">All Categories</option>
        <option value="architecture">Architecture</option>
        <option value="decision">Decision</option>
        <option value="error">Error</option>
        <option value="finding">Finding</option>
        <option value="file_change">File Change</option>
        <option value="note">Note</option>
      </select>
      <select id="mem-sort">
        <option value="score" data-i18n="mem.sortScore">Score</option>
        <option value="created" data-i18n="mem.sortCreated">Created</option>
        <option value="accessed" data-i18n="mem.sortAccessed">Last Accessed</option>
        <option value="access_count" data-i18n="mem.sortHits">Access Count</option>
      </select>
      <button class="btn" id="btn-export-json" data-i18n="mem.exportJson">Export JSON</button>
    </div>
    <div class="bulk-bar" id="bulk-bar">
      <span id="bulk-count"></span>
      <button class="btn btn-danger btn-sm" id="btn-bulk-delete" data-i18n="mem.deleteSelected">Delete Selected</button>
      <button class="btn-outline btn-sm" id="btn-bulk-clear" data-i18n="mem.clearSelection">Clear</button>
    </div>
    <div id="memories-table"></div>
    <div class="pagination" id="mem-pagination"></div>
  </div>

  <!-- Projects -->
  <div id="page-projects" class="page">
    <div class="page-header"><h2 class="page-title" data-i18n="nav.projects">Projects</h2></div>
    <div class="projects-grid" id="projects-list"></div>
  </div>

  <!-- Sessions -->
  <div id="page-sessions" class="page">
    <div class="page-header"><h2 class="page-title" data-i18n="nav.sessions">Sessions</h2></div>
    <div id="sessions-list"></div>
  </div>

  <!-- Config -->
  <div id="page-config" class="page">
    <div class="page-header"><h2 class="page-title" data-i18n="nav.config">Settings</h2></div>
    <div id="config-sections"></div>
    <div style="display:flex;gap:12px;margin-bottom:20px">
      <button class="btn" id="btn-cfg-save" disabled data-i18n="config.save">Save</button>
      <button class="btn-outline btn" id="btn-cfg-reset" data-i18n="config.resetDefaults">Reset to Defaults</button>
    </div>
    <div class="config-section">
      <h3 data-i18n="config.maintenance">Maintenance</h3>
      <div style="display:flex;gap:12px;flex-wrap:wrap">
        <button class="btn" id="btn-prune" data-i18n="config.runPrune">Decay &amp; Prune</button>
        <button class="btn-outline btn" id="btn-prune-old" data-i18n="config.pruneOld">Prune Old (30d)</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal (memory detail) -->
<div class="modal-overlay" id="modal-overlay">
  <div class="modal" id="modal-content"></div>
</div>

<!-- Confirm dialog -->
<div class="confirm-overlay" id="confirm-overlay">
  <div class="confirm-box" id="confirm-box">
    <h3 id="confirm-title"></h3>
    <p id="confirm-msg"></p>
    <div class="actions">
      <button class="btn-outline btn" id="confirm-cancel" data-i18n="confirm.cancel">Cancel</button>
      <button class="btn btn-danger" id="confirm-ok" data-i18n="confirm.confirm">Confirm</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Tooltip -->
<div id="tooltip"></div>

<!-- Onboarding -->
<div class="onboard-overlay" id="onboard-overlay">
  <div class="onboard">
    <h2 data-i18n="onboard.title">Welcome to Infinite Context</h2>
    <p class="sub" data-i18n="onboard.sub">Persistent memory for your AI coding sessions</p>
    <div class="steps">
      <div class="step"><div class="step-num">1</div><div class="step-text" data-i18n="onboard.step1"><strong>Install</strong> &mdash; npm install -g infinite-context</div></div>
      <div class="step"><div class="step-num">2</div><div class="step-text" data-i18n="onboard.step2"><strong>Use</strong> &mdash; Start a Claude Code session; memories are created automatically</div></div>
      <div class="step"><div class="step-num">3</div><div class="step-text" data-i18n="onboard.step3"><strong>Explore</strong> &mdash; Come back here to browse, search, and manage memories</div></div>
    </div>
    <button class="btn" id="btn-onboard-dismiss" data-i18n="onboard.dismiss">Get Started</button>
  </div>
</div>

<script>
/* ---- i18n ---- */
const I18N = {
  en: {
    'nav.overview':'Overview','nav.memories':'Memories','nav.projects':'Projects','nav.sessions':'Sessions','nav.config':'Settings',
    'overview.totalMemories':'Total Memories','overview.dbSize':'Database Size','overview.sessions':'Sessions','overview.decayFactor':'Decay Factor',
    'overview.maxPerProject':'max per project','overview.active':'active','overview.pruneBelow':'Prune below',
    'overview.noSessions':'No sessions yet','overview.updated':'Updated','overview.catDist':'Category Distribution',
    'overview.recentSessions':'Recent Sessions','overview.scoreDist':'Score Distribution','overview.activity':'Activity (30 days)',
    'tip.totalMemories':'Total number of stored memories across all projects.','tip.dbSize':'SQLite database file size on disk.',
    'tip.sessions':'Total coding sessions tracked. Active = currently running.','tip.decay':'Score multiplier applied periodically. 0.95 = -5% per interval.',
    'tip.score':'Relevance score (0\u20131). Higher = more important. Decays over time if unused.',
    'mem.searchPlaceholder':'Search memories...','mem.allProjects':'All Projects','mem.allCategories':'All Categories',
    'mem.sortScore':'Score','mem.sortCreated':'Created','mem.sortAccessed':'Last Accessed','mem.sortHits':'Access Count',
    'mem.noResults':'No memories found','mem.prev':'Prev','mem.next':'Next','mem.total':'total',
    'mem.exportJson':'Export JSON','mem.deleteSelected':'Delete Selected','mem.clearSelection':'Clear',
    'mem.selected':'selected','mem.deleted':'deleted','mem.notFound':'Memory not found',
    'th.id':'ID','th.category':'Category','th.content':'Content','th.score':'Score','th.created':'Created','th.hits':'Hits','th.delete':'',
    'modal.close':'Close','modal.delete':'Delete','modal.category':'Category','modal.content':'Content',
    'modal.keywords':'Keywords','modal.score':'Score','modal.accessCount':'Access Count','modal.created':'Created',
    'modal.lastAccessed':'Last Accessed','modal.project':'Project','modal.session':'Session',
    'modal.sourceHash':'Source Hash','modal.metadata':'Metadata',
    'cat.architecture':'Architecture','cat.decision':'Decision','cat.error':'Error','cat.finding':'Finding','cat.file_change':'File Change','cat.note':'Note',
    'projects.noProjects':'No projects yet','projects.export':'Export',
    'sessions.noSessions':'No sessions yet','sessions.started':'Started','sessions.ended':'Ended','sessions.project':'Project',
    'stat.memories':'memories','stat.compactions':'compactions',
    'config.memMgmt':'Memory Management','config.decayPrune':'Decay & Pruning','config.catWeights':'Category Weights','config.maintenance':'Maintenance',
    'config.save':'Save','config.resetDefaults':'Reset to Defaults','config.saved':'Configuration saved','config.resetDone':'Reset to defaults',
    'config.runPrune':'Decay & Prune','config.pruneOld':'Prune Old (30d)','config.pruned':'Pruned',
    'config.previewPrune':'Preview: {belowScore} below threshold, {old} old unused. Proceed?',
    'tip.maxMemoriesPerProject':'Maximum memories stored per project before pruning.','tip.maxRestoreTokens':'Max tokens loaded into context on session restore.',
    'tip.maxMemoriesPerRestore':'Max memories restored at session start.','tip.maxPromptRecallResults':'Max results returned from prompt-based recall.',
    'tip.decayFactor':'Multiplier applied to scores. Lower = faster decay.','tip.pruneThreshold':'Memories below this score get deleted.',
    'tip.scoreFloor':'Minimum score a memory can decay to.','tip.decayIntervalDays':'Days of inactivity before decay applies.',
    'confirm.deleteTitle':'Delete Memory','confirm.deleteMsg':'Delete memory #{id}? This cannot be undone.',
    'confirm.bulkDeleteTitle':'Delete Memories','confirm.bulkDeleteMsg':'Delete {n} selected memories? This cannot be undone.',
    'confirm.resetTitle':'Reset Configuration','confirm.resetMsg':'Reset all settings to defaults? This cannot be undone.',
    'confirm.cancel':'Cancel','confirm.confirm':'Confirm',
    'onboard.title':'Welcome to Infinite Context','onboard.sub':'Persistent memory for your AI coding sessions',
    'onboard.step1':'<strong>Install</strong> \u2014 npm install -g infinite-context',
    'onboard.step2':'<strong>Use</strong> \u2014 Start a Claude Code session; memories are created automatically',
    'onboard.step3':'<strong>Explore</strong> \u2014 Come back here to browse, search, and manage memories',
    'onboard.dismiss':'Get Started',
    'time.justNow':'just now','time.mAgo':'m ago','time.hAgo':'h ago','time.dAgo':'d ago',
    'avg':'avg','project':'project','projects':'projects',
    'config.extraction':'Extraction Mode','config.modeRules':'Rules (regex)','config.modeLlm':'LLM (Claude)','config.modeHybrid':'Hybrid (both)',
    'config.llmModel':'LLM Model',
    'tip.extractionMode':'How memories are extracted. Rules: fast, free, regex-based. LLM: smart, costs API tokens, Claude analyzes transcript. Hybrid: both methods combined.',
    'tip.llmModel':'Claude model for LLM extraction. Haiku recommended for speed and cost.',
    'tip.llmMaxTranscriptChars':'Max transcript characters sent to LLM per extraction.',
    'project.mode':'Mode','project.modeDefault':'Default','project.modeSet':'Mode saved',
  },
  ru: {
    'nav.overview':'Обзор','nav.memories':'Воспоминания','nav.projects':'Проекты','nav.sessions':'Сессии','nav.config':'Настройки',
    'overview.totalMemories':'Всего воспоминаний','overview.dbSize':'Размер БД','overview.sessions':'Сессии','overview.decayFactor':'Фактор затухания',
    'overview.maxPerProject':'макс. на проект','overview.active':'активных','overview.pruneBelow':'Удалять ниже',
    'overview.noSessions':'Сессий пока нет','overview.updated':'Обновлено','overview.catDist':'Распределение по категориям',
    'overview.recentSessions':'Последние сессии','overview.scoreDist':'Распределение оценок','overview.activity':'Активность (30 дней)',
    'tip.totalMemories':'Общее количество хранимых воспоминаний по всем проектам.','tip.dbSize':'Размер файла базы данных SQLite на диске.',
    'tip.sessions':'Отслеживаемые сессии. Активные = запущенные сейчас.','tip.decay':'Множитель оценки. 0.95 = -5% за период.',
    'tip.score':'Оценка релевантности (0\u20131). Выше = важнее. Снижается со временем при неиспользовании.',
    'mem.searchPlaceholder':'Поиск по воспоминаниям...','mem.allProjects':'Все проекты','mem.allCategories':'Все категории',
    'mem.sortScore':'Оценка','mem.sortCreated':'Создано','mem.sortAccessed':'Последний доступ','mem.sortHits':'Обращений',
    'mem.noResults':'Ничего не найдено','mem.prev':'Назад','mem.next':'Далее','mem.total':'всего',
    'mem.exportJson':'Экспорт JSON','mem.deleteSelected':'Удалить выбранные','mem.clearSelection':'Снять',
    'mem.selected':'выбрано','mem.deleted':'удалено','mem.notFound':'Запись не найдена',
    'th.id':'ID','th.category':'Категория','th.content':'Содержимое','th.score':'Оценка','th.created':'Создано','th.hits':'Хиты','th.delete':'',
    'modal.close':'Закрыть','modal.delete':'Удалить','modal.category':'Категория','modal.content':'Содержимое',
    'modal.keywords':'Ключевые слова','modal.score':'Оценка','modal.accessCount':'Обращений','modal.created':'Создано',
    'modal.lastAccessed':'Последний доступ','modal.project':'Проект','modal.session':'Сессия',
    'modal.sourceHash':'Хеш источника','modal.metadata':'Метаданные',
    'cat.architecture':'Архитектура','cat.decision':'Решение','cat.error':'Ошибка','cat.finding':'Находка','cat.file_change':'Изменение файла','cat.note':'Заметка',
    'projects.noProjects':'Проектов пока нет','projects.export':'Экспорт',
    'sessions.noSessions':'Сессий пока нет','sessions.started':'Начало','sessions.ended':'Конец','sessions.project':'Проект',
    'stat.memories':'записей','stat.compactions':'сжатий',
    'config.memMgmt':'Управление памятью','config.decayPrune':'Затухание и очистка','config.catWeights':'Веса категорий','config.maintenance':'Обслуживание',
    'config.save':'Сохранить','config.resetDefaults':'Сбросить настройки','config.saved':'Настройки сохранены','config.resetDone':'Настройки сброшены',
    'config.runPrune':'Затухание и очистка','config.pruneOld':'Очистить старые (30д)','config.pruned':'Очищено',
    'config.previewPrune':'Предпросмотр: {belowScore} ниже порога, {old} старых неиспользуемых. Продолжить?',
    'tip.maxMemoriesPerProject':'Максимум воспоминаний на проект до очистки.','tip.maxRestoreTokens':'Макс. токенов, загружаемых в контекст при восстановлении.',
    'tip.maxMemoriesPerRestore':'Макс. воспоминаний, восстанавливаемых при старте.','tip.maxPromptRecallResults':'Макс. результатов при вызове из промпта.',
    'tip.decayFactor':'Множитель оценки. Меньше = быстрее затухание.','tip.pruneThreshold':'Воспоминания ниже этой оценки удаляются.',
    'tip.scoreFloor':'Минимальная оценка, до которой может упасть запись.','tip.decayIntervalDays':'Дней бездействия до применения затухания.',
    'confirm.deleteTitle':'Удалить воспоминание','confirm.deleteMsg':'Удалить воспоминание #{id}? Это необратимо.',
    'confirm.bulkDeleteTitle':'Удалить воспоминания','confirm.bulkDeleteMsg':'Удалить {n} выбранных воспоминаний? Это необратимо.',
    'confirm.resetTitle':'Сброс настроек','confirm.resetMsg':'Сбросить все настройки к значениям по умолчанию? Это необратимо.',
    'confirm.cancel':'Отмена','confirm.confirm':'Подтвердить',
    'onboard.title':'Добро пожаловать в Infinite Context','onboard.sub':'Постоянная память для сессий программирования с ИИ',
    'onboard.step1':'<strong>Установите</strong> \u2014 npm install -g infinite-context',
    'onboard.step2':'<strong>Используйте</strong> \u2014 Начните сессию Claude Code; воспоминания создаются автоматически',
    'onboard.step3':'<strong>Исследуйте</strong> \u2014 Возвращайтесь сюда для поиска и управления воспоминаниями',
    'onboard.dismiss':'Начать',
    'time.justNow':'только что','time.mAgo':'м назад','time.hAgo':'ч назад','time.dAgo':'д назад',
    'avg':'сред','project':'проект','projects':'проектов',
    'config.extraction':'Режим извлечения','config.modeRules':'Правила (regex)','config.modeLlm':'LLM (Claude)','config.modeHybrid':'Гибрид (оба)',
    'config.llmModel':'Модель LLM',
    'tip.extractionMode':'Как извлекаются воспоминания. Rules: быстро, бесплатно, regex. LLM: умно, стоит токены, Claude анализирует транскрипт. Hybrid: оба метода.',
    'tip.llmModel':'Модель Claude для LLM-извлечения. Haiku рекомендуется для скорости и экономии.',
    'tip.llmMaxTranscriptChars':'Максимум символов транскрипта для отправки в LLM.',
    'project.mode':'Режим','project.modeDefault':'По умолчанию','project.modeSet':'Режим сохранён',
  }
};

/* ---- State ---- */
const S = {
  lang: localStorage.getItem('ic-lang') || (navigator.language.startsWith('ru') ? 'ru' : 'en'),
  mem: { page:1, sort:'score', order:'desc', selected: new Set() },
  cfgOriginal: null, cfgDirty: false,
  refreshTimer: null
};

/* ---- Helpers ---- */
function t(k, vars) {
  let s = (I18N[S.lang] && I18N[S.lang][k]) || I18N.en[k] || k;
  if (vars) for (const [vk, vv] of Object.entries(vars)) s = s.replace('{' + vk + '}', vv);
  return s;
}
function escHtml(s) { if (s == null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function escAttr(s) { return escHtml(s).replace(/'/g,'&#39;'); }
function $(id) { return document.getElementById(id); }
function formatBytes(b) { if (b < 1024) return b + ' B'; if (b < 1048576) return (b/1024).toFixed(1) + ' KB'; return (b/1048576).toFixed(1) + ' MB'; }
function timeAgo(d) {
  if (!d) return '\u2014';
  const diff = (Date.now() - new Date(d + (d.includes('Z')||d.includes('+') ? '' : 'Z')).getTime()) / 1000;
  if (diff < 60) return t('time.justNow');
  if (diff < 3600) return Math.floor(diff/60) + t('time.mAgo');
  if (diff < 86400) return Math.floor(diff/3600) + t('time.hAgo');
  return Math.floor(diff/86400) + t('time.dAgo');
}
function shortPath(p, max) { max = max || 40; if (!p || p.length <= max) return p || '\u2014'; return '\u2026' + p.slice(-(max-1)); }
function scoreColor(s) { return s >= .8 ? 'var(--success)' : s >= .5 ? 'var(--primary)' : s >= .3 ? 'var(--warning)' : 'var(--danger)'; }
const CAT_COLORS = { architecture:'#818cf8', decision:'#f59e0b', error:'#ef4444', finding:'#22c55e', file_change:'#3b82f6', note:'#71717a' };

/* ---- API ---- */
async function api(path, opts) {
  try { const r = await fetch(path, opts); return r.json(); }
  catch (e) { toast(e.message, 'danger'); return null; }
}

/* ---- Toast ---- */
let toastTimer;
function toast(msg, cls) {
  const el = $('toast');
  el.textContent = msg;
  el.className = 'toast show' + (cls ? ' ' + cls : '');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 3000);
}

/* ---- Confirm ---- */
let confirmCb = null;
function confirm_(title, msg, cb) {
  $('confirm-title').textContent = title;
  $('confirm-msg').textContent = msg;
  $('confirm-overlay').classList.add('show');
  confirmCb = cb;
}
$('confirm-cancel').onclick = () => { $('confirm-overlay').classList.remove('show'); confirmCb = null; };
$('confirm-ok').onclick = () => { $('confirm-overlay').classList.remove('show'); if (confirmCb) confirmCb(); confirmCb = null; };

/* ---- Tooltip ---- */
document.addEventListener('mouseover', e => {
  const el = e.target.closest('[data-tip]');
  if (!el) { $('tooltip').style.display = 'none'; return; }
  const tip = $('tooltip');
  tip.textContent = t(el.dataset.tip);
  tip.style.display = 'block';
  const r = el.getBoundingClientRect();
  tip.style.left = Math.min(r.left, window.innerWidth - 320) + 'px';
  tip.style.top = (r.bottom + 6) + 'px';
});
document.addEventListener('mouseout', e => {
  if (e.target.closest('[data-tip]')) $('tooltip').style.display = 'none';
});

/* ---- Modal ---- */
function openModal(html) { $('modal-content').innerHTML = html; $('modal-overlay').classList.add('show'); }
function closeModal() { $('modal-overlay').classList.remove('show'); }
$('modal-overlay').onclick = e => { if (e.target === $('modal-overlay')) closeModal(); };
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') { closeModal(); $('confirm-overlay').classList.remove('show'); }
});

/* ---- i18n apply ---- */
function applyI18n() {
  document.querySelectorAll('[data-i18n]').forEach(el => {
    const v = t(el.dataset.i18n);
    if (el.dataset.i18n.startsWith('onboard.step')) el.innerHTML = v; else el.textContent = v;
  });
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => { el.placeholder = t(el.dataset.i18nPlaceholder); });
  document.querySelectorAll('.lang-btn').forEach(b => b.classList.toggle('active', b.dataset.lang === S.lang));
  document.documentElement.lang = S.lang;
}

/* ---- Navigation ---- */
function navigate(page) {
  location.hash = page;
  document.querySelectorAll('.nav-item').forEach(n => n.classList.toggle('active', n.dataset.page === page));
  document.querySelectorAll('.page').forEach(p => p.classList.toggle('active', p.id === 'page-' + page));
  if (page === 'overview') loadOverview();
  else if (page === 'memories') loadMemories();
  else if (page === 'projects') loadProjects();
  else if (page === 'sessions') loadSessions();
  else if (page === 'config') loadConfig();
}

/* ---- Skeleton ---- */
function skeleton(el, n) { el.innerHTML = Array.from({length: n||3}, () => '<div class="skeleton" style="height:40px"></div>').join(''); }

/* ---- Overview ---- */
async function loadOverview() {
  skeleton($('stats-grid'), 4);
  const data = await api('/api/stats');
  if (!data) return;

  if (data.total === 0 && !localStorage.getItem('ic-onboard-done')) {
    $('onboard-overlay').classList.add('show');
  }

  $('last-refresh').textContent = t('overview.updated') + ' ' + new Date().toLocaleTimeString();
  const pLabel = data.byProject.length !== 1 ? t('projects') : t('project');
  $('stats-grid').innerHTML =
    statCard(t('overview.totalMemories'), data.total, data.byProject.length + ' ' + pLabel, 'tip.totalMemories') +
    statCard(t('overview.dbSize'), formatBytes(data.dbSize), data.config.maxMemoriesPerProject + ' ' + t('overview.maxPerProject'), 'tip.dbSize') +
    statCard(t('overview.sessions'), data.sessions.length, data.sessions.filter(s => !s.ended_at).length + ' ' + t('overview.active'), 'tip.sessions') +
    statCard(t('overview.decayFactor'), data.config.decayFactor, t('overview.pruneBelow') + ' ' + data.config.pruneThreshold, 'tip.decay');

  renderScoreChart(data.scoreDistribution || []);
  renderTimeline(data.timeline || []);

  const maxCat = Math.max(1, ...data.categories.map(c => c.cnt));
  $('cat-bars').innerHTML = data.categories.map(c => `<div class="cat-bar" onclick="navMemCat('${escAttr(c.category)}')">
    <div class="cat-name">${escHtml(t('cat.' + c.category) || c.category)}</div>
    <div class="bar-wrap"><div class="bar-fill" style="width:${(c.cnt/maxCat*100).toFixed(1)}%;background:${CAT_COLORS[c.category]||'#666'}">${c.cnt > 0 ? t('avg') + ' ' + c.avg_score.toFixed(2) : ''}</div></div>
    <div class="bar-count">${c.cnt}</div>
  </div>`).join('');

  $('recent-sessions').innerHTML = data.sessions.length === 0
    ? '<div class="empty">' + t('overview.noSessions') + '</div>'
    : data.sessions.slice(0, 5).map(s => `<div class="card"><div class="card-row">
    <div style="flex:1;min-width:0"><div class="session-id">${escHtml(s.session_id.slice(0,20))}\u2026</div>
    <div class="session-meta"><span>${escHtml(s.started_at)}</span><span>${s.ended_at ? '\u2192 ' + escHtml(s.ended_at) : '(\u25cf ' + t('overview.active') + ')'}</span></div></div>
    <div class="session-stats">
      <div><div class="num">${s.memories_created}</div><div class="lbl">${t('stat.memories')}</div></div>
      <div><div class="num">${s.compactions}</div><div class="lbl">${t('stat.compactions')}</div></div>
    </div></div></div>`).join('');
}

function statCard(label, value, sub, tip) {
  return `<div class="stat-card"><div class="label">${escHtml(label)} <span class="tip-icon" data-tip="${escAttr(tip)}">?</span></div><div class="value">${escHtml(String(value))}</div><div class="sub">${escHtml(sub)}</div></div>`;
}

function renderScoreChart(dist) {
  const buckets = Array.from({length:10}, (_,i) => ({ bucket:i, cnt:0 }));
  dist.forEach(d => { if (d.bucket >= 0 && d.bucket < 10) buckets[d.bucket].cnt = d.cnt; });
  const max = Math.max(1, ...buckets.map(b => b.cnt));
  const w = 300, h = 130, px = 10, topPad = 18, botPad = 18;
  const barArea = h - topPad - botPad;
  const bw = (w - 2*px) / 10 - 3;
  const gap = 3;
  let svg = '';
  for (let i = 0; i <= 3; i++) {
    const y = topPad + (1 - i/3) * barArea;
    svg += `<line x1="${px}" y1="${y}" x2="${w-px}" y2="${y}" stroke="var(--border)" stroke-width="0.5" stroke-dasharray="2,2"/>`;
  }
  buckets.forEach((b, i) => {
    const x = px + i * (bw + gap);
    const bh = b.cnt > 0 ? Math.max(3, (b.cnt / max) * barArea) : 0;
    const y = topPad + barArea - bh;
    if (b.cnt > 0) {
      svg += `<rect x="${x}" y="${y}" width="${bw}" height="${bh}" rx="3" fill="var(--primary)" opacity="${0.5 + 0.5*(b.cnt/max)}"><title>${(i/10).toFixed(1)}\u2013${((i+1)/10).toFixed(1)}: ${b.cnt}</title></rect>`;
      svg += `<text x="${x+bw/2}" y="${y-4}" fill="var(--muted)" font-size="9" text-anchor="middle">${b.cnt}</text>`;
    }
    svg += `<text x="${x+bw/2}" y="${h-3}" fill="var(--muted)" font-size="9" text-anchor="middle">.${i}</text>`;
  });
  $('score-chart').innerHTML = `<svg viewBox="0 0 ${w} ${h}" style="width:100%">${svg}</svg>`;
}

function renderTimeline(tl) {
  if (tl.length < 2) { $('timeline-chart').innerHTML = '<div class="empty" style="padding:20px">\u2014</div>'; return; }
  const max = Math.max(1, ...tl.map(d => d.cnt));
  const w = 300, h = 80, px = 10, py = 10;
  const pts = tl.map((d, i) => {
    const x = px + (i / (tl.length - 1)) * (w - 2*px);
    const y = py + (1 - d.cnt / max) * (h - 2*py);
    return x + ',' + y;
  }).join(' ');
  const area = px + ',' + (h-py) + ' ' + pts + ' ' + (px + (w - 2*px)) + ',' + (h-py);
  $('timeline-chart').innerHTML = `<svg viewBox="0 0 ${w} ${h}" style="width:100%">
    <polygon points="${area}" fill="var(--primary)" opacity="0.15"/>
    <polyline points="${pts}" fill="none" stroke="var(--primary)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
    ${tl.map((d,i) => { const x = px + (i/(tl.length-1))*(w-2*px); const y = py + (1-d.cnt/max)*(h-2*py); return `<circle cx="${x}" cy="${y}" r="2.5" fill="var(--primary)"><title>${escHtml(d.day)}: ${d.cnt}</title></circle>`; }).join('')}
  </svg>`;
}

function navMemCat(cat) {
  $('mem-category').value = cat;
  navigate('memories');
}

/* ---- Memories ---- */
let searchTimer;
$('mem-search').addEventListener('input', () => { clearTimeout(searchTimer); searchTimer = setTimeout(() => loadMemories(1), 300); });
$('mem-project').addEventListener('change', () => loadMemories(1));
$('mem-category').addEventListener('change', () => loadMemories(1));
$('mem-sort').addEventListener('change', () => { S.mem.sort = $('mem-sort').value; loadMemories(1); });

async function loadMemories(page) {
  if (page !== undefined) S.mem.page = page;
  S.mem.selected.clear();
  updateBulkBar();
  skeleton($('memories-table'), 5);

  const p = new URLSearchParams({ page: S.mem.page, limit: 50, sort: S.mem.sort, order: S.mem.order });
  const search = $('mem-search').value.trim();
  const project = $('mem-project').value;
  const category = $('mem-category').value;
  if (search) p.set('search', search);
  if (project) p.set('project', project);
  if (category) p.set('category', category);

  const data = await api('/api/memories?' + p);
  if (!data) return;

  if (data.rows.length === 0) {
    $('memories-table').innerHTML = '<div class="empty">' + t('mem.noResults') + '</div>';
    $('mem-pagination').innerHTML = '';
    return;
  }

  const sortKey = S.mem.sort;
  const sortDir = S.mem.order;
  function thSorted(col, label) {
    const active = sortKey === col;
    const arrow = active ? (sortDir === 'desc' ? '\u2193' : '\u2191') : '';
    return `<th class="${active?'sorted':''}" data-sort="${col}">${escHtml(label)} <span class="arrow">${arrow}</span></th>`;
  }

  $('memories-table').innerHTML = `<table><tr>
    <th style="width:30px"><input type="checkbox" class="chk" id="chk-all"></th>
    <th style="width:40px" data-sort="id">${t('th.id')}</th>
    <th style="width:100px">${t('th.category')}</th>
    ${thSorted('score', t('th.score'))}
    <th>${t('th.content')}</th>
    ${thSorted('created', t('th.created'))}
    ${thSorted('access_count', t('th.hits'))}
    <th style="width:40px"></th>
  </tr>${data.rows.map(m => `<tr data-id="${m.id}">
    <td><input type="checkbox" class="chk chk-row" value="${m.id}"></td>
    <td style="color:var(--muted);font-size:12px">${m.id}</td>
    <td><span class="badge badge-${escAttr(m.category)}">${escHtml(t('cat.'+m.category)||m.category)}</span></td>
    <td><span class="score-bar"><span class="score-fill" style="width:${(m.score*100).toFixed(0)}%;background:${scoreColor(m.score)}"></span></span><span style="font-size:12px">${m.score.toFixed(3)}</span></td>
    <td class="content-cell" onclick="showMemory(${m.id})">${escHtml(m.content)}</td>
    <td style="font-size:12px;color:var(--muted)">${timeAgo(m.created_at)}</td>
    <td style="text-align:center;color:var(--muted)">${m.access_count}</td>
    <td><button class="btn-sm btn-danger" onclick="deleteMemory(${m.id},event)">\u00d7</button></td>
  </tr>`).join('')}</table>`;

  // Sortable headers
  $('memories-table').querySelectorAll('th[data-sort]').forEach(th => {
    th.style.cursor = 'pointer';
    th.onclick = () => {
      const col = th.dataset.sort;
      if (S.mem.sort === col) S.mem.order = S.mem.order === 'desc' ? 'asc' : 'desc';
      else { S.mem.sort = col; S.mem.order = 'desc'; }
      $('mem-sort').value = col;
      loadMemories(1);
    };
  });

  // Checkboxes
  $('chk-all').onchange = function() {
    $('memories-table').querySelectorAll('.chk-row').forEach(c => { c.checked = this.checked; toggleSelected(+c.value, this.checked); });
    updateBulkBar();
  };
  $('memories-table').querySelectorAll('.chk-row').forEach(c => {
    c.onchange = () => { toggleSelected(+c.value, c.checked); updateBulkBar(); };
  });

  // Pagination
  const pg = $('mem-pagination');
  if (data.pages > 1) {
    pg.innerHTML = `<button ${S.mem.page<=1?'disabled':''} onclick="loadMemories(${S.mem.page-1})">\u2190 ${t('mem.prev')}</button>
    <span class="page-info">${S.mem.page} / ${data.pages} (${data.total} ${t('mem.total')})</span>
    <button ${S.mem.page>=data.pages?'disabled':''} onclick="loadMemories(${S.mem.page+1})">${t('mem.next')} \u2192</button>`;
  } else {
    pg.innerHTML = '<span class="page-info">' + data.total + ' ' + t('mem.total') + '</span>';
  }
}

function toggleSelected(id, on) { if (on) S.mem.selected.add(id); else S.mem.selected.delete(id); }
function updateBulkBar() {
  const n = S.mem.selected.size;
  const bar = $('bulk-bar');
  if (n > 0) { bar.classList.add('show'); $('bulk-count').textContent = n + ' ' + t('mem.selected'); }
  else bar.classList.remove('show');
}

$('btn-bulk-delete').onclick = () => {
  const ids = [...S.mem.selected];
  confirm_(t('confirm.bulkDeleteTitle'), t('confirm.bulkDeleteMsg', {n: ids.length}), async () => {
    const res = await api('/api/memories/bulk-delete', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ids}) });
    if (res) { toast(res.deleted + ' ' + t('mem.deleted'), 'success'); loadMemories(); }
  });
};
$('btn-bulk-clear').onclick = () => {
  S.mem.selected.clear(); updateBulkBar();
  $('memories-table').querySelectorAll('.chk-row').forEach(c => c.checked = false);
  if ($('chk-all')) $('chk-all').checked = false;
};

$('btn-export-json').onclick = async () => {
  const p = new URLSearchParams({ page:1, limit:10000, sort:S.mem.sort, order:S.mem.order });
  const search = $('mem-search').value.trim();
  const project = $('mem-project').value;
  const category = $('mem-category').value;
  if (search) p.set('search', search);
  if (project) p.set('project', project);
  if (category) p.set('category', category);
  const data = await api('/api/memories?' + p);
  if (!data) return;
  const blob = new Blob([JSON.stringify(data.rows, null, 2)], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'memories-export.json';
  a.click();
  URL.revokeObjectURL(a.href);
};

async function showMemory(id) {
  const m = await api('/api/memories/' + id);
  if (!m || m.error) return toast(t('mem.notFound'), 'danger');
  let meta = '\u2014';
  try { meta = m.metadata ? JSON.stringify(JSON.parse(m.metadata), null, 2) : '\u2014'; } catch { meta = m.metadata || '\u2014'; }
  openModal(`<h2>Memory #${m.id}</h2>
    <div class="field"><div class="field-label">${t('modal.category')}</div><div class="field-value"><span class="badge badge-${escAttr(m.category)}">${escHtml(t('cat.'+m.category)||m.category)}</span></div></div>
    <div class="field"><div class="field-label">${t('modal.content')}</div><div class="field-value" style="white-space:pre-wrap;background:var(--surface2);padding:12px;border-radius:6px;max-height:300px;overflow-y:auto">${escHtml(m.content)}</div></div>
    <div class="field"><div class="field-label">${t('modal.keywords')}</div><div class="field-value" style="color:var(--muted)">${escHtml(m.keywords)}</div></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="field"><div class="field-label">${t('modal.score')}</div><div class="field-value">${m.score.toFixed(4)}</div></div>
      <div class="field"><div class="field-label">${t('modal.accessCount')}</div><div class="field-value">${m.access_count}</div></div>
      <div class="field"><div class="field-label">${t('modal.created')}</div><div class="field-value">${escHtml(m.created_at)}</div></div>
      <div class="field"><div class="field-label">${t('modal.lastAccessed')}</div><div class="field-value">${escHtml(m.last_accessed)}</div></div>
      <div class="field"><div class="field-label">${t('modal.project')}</div><div class="field-value" style="font-size:12px;word-break:break-all">${escHtml(m.project)}</div></div>
      <div class="field"><div class="field-label">${t('modal.session')}</div><div class="field-value" style="font-size:12px">${escHtml((m.session_id||'').slice(0,16))}\u2026</div></div>
    </div>
    <div class="field"><div class="field-label">${t('modal.sourceHash')}</div><div class="field-value" style="font-family:monospace;font-size:12px">${escHtml(m.source_hash) || '\u2014'}</div></div>
    <div class="field"><div class="field-label">${t('modal.metadata')}</div><div class="field-value" style="font-family:monospace;font-size:12px;white-space:pre-wrap">${escHtml(meta)}</div></div>
    <div class="actions">
      <button class="btn-outline btn" onclick="closeModal()">${t('modal.close')}</button>
      <button class="btn btn-danger" onclick="deleteMemory(${m.id});closeModal()">${t('modal.delete')}</button>
    </div>`);
}

function deleteMemory(id, ev) {
  if (ev) ev.stopPropagation();
  confirm_(t('confirm.deleteTitle'), t('confirm.deleteMsg', {id}), async () => {
    const res = await api('/api/memories/' + id, { method:'DELETE' });
    if (res && res.deleted) { toast('Memory #' + id + ' ' + t('mem.deleted'), 'success'); loadMemories(); }
  });
}

/* ---- Projects ---- */
async function loadProjects() {
  skeleton($('projects-list'), 3);
  const data = await api('/api/projects');
  if (!data) return;

  // Also populate dropdown
  $('mem-project').innerHTML = '<option value="">' + t('mem.allProjects') + '</option>' +
    data.map(p => '<option value="' + escAttr(p.project) + '">' + escHtml(shortPath(p.project, 60)) + '</option>').join('');

  if (data.length === 0) { $('projects-list').innerHTML = '<div class="empty">' + t('projects.noProjects') + '</div>'; return; }
  const globalMode = cfgData.extractionMode || 'rules';
  $('projects-list').innerHTML = data.map(p => `<div class="project-card" onclick="navToProject('${escAttr(p.project)}')">
    <div class="proj-name">${escHtml(shortPath(p.project, 40))}</div>
    <div class="proj-path">${escHtml(p.project)}</div>
    <div class="proj-footer">
      <select class="btn-outline btn-sm" onclick="event.stopPropagation()" onchange="setProjectMode(this,'${escAttr(p.project)}')">
        <option value="" ${!p.extractionMode?'selected':''}>${t('project.modeDefault')} (${globalMode})</option>
        <option value="rules" ${p.extractionMode==='rules'?'selected':''}>${t('config.modeRules')}</option>
        <option value="llm" ${p.extractionMode==='llm'?'selected':''}>${t('config.modeLlm')}</option>
        <option value="hybrid" ${p.extractionMode==='hybrid'?'selected':''}>${t('config.modeHybrid')}</option>
      </select>
      <button class="btn-outline btn-sm" onclick="exportProject('${escAttr(p.project)}',event)">${t('projects.export')}</button>
      <div class="proj-count"><div class="num">${p.cnt}</div><div class="lbl">${t('stat.memories')}</div></div>
    </div>
  </div>`).join('');
}

async function setProjectMode(select, project) {
  const mode = select.value || null;
  const body = { project };
  if (mode) body.extractionMode = mode; else body.extractionMode = null;
  await api('/api/project-config', { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
  toast(t('project.modeSet'), 'success');
}

function navToProject(project) {
  $('mem-project').value = project;
  navigate('memories');
}

function exportProject(project, ev) {
  ev.stopPropagation();
  const p = new URLSearchParams({ page:1, limit:10000, sort:'score', order:'desc', project });
  api('/api/memories?' + p).then(data => {
    if (!data) return;
    const blob = new Blob([JSON.stringify(data.rows, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'project-export.json';
    a.click();
    URL.revokeObjectURL(a.href);
  });
}

/* ---- Sessions ---- */
async function loadSessions() {
  skeleton($('sessions-list'), 3);
  const data = await api('/api/sessions');
  if (!data) return;
  if (data.length === 0) { $('sessions-list').innerHTML = '<div class="empty">' + t('sessions.noSessions') + '</div>'; return; }
  $('sessions-list').innerHTML = data.map(s => `<div class="card"><div class="card-row">
    <div style="flex:1;min-width:0"><div class="session-id">${escHtml(s.session_id.slice(0,24))}${s.session_id.length > 24 ? '\u2026' : ''}</div>
    <div class="session-meta" style="margin-top:6px">
      <span>${t('sessions.started')}: ${escHtml(s.started_at)}</span>
      ${s.ended_at ? '<span>' + t('sessions.ended') + ': ' + escHtml(s.ended_at) + '</span>' : '<span style="color:var(--success)">\u25cf ' + t('overview.active') + '</span>'}
    </div>
    <div class="session-meta" style="margin-top:4px"><span>${t('sessions.project')}: ${escHtml(shortPath(s.project, 50))}</span></div></div>
    <div class="session-stats">
      <div><div class="num">${s.memories_created}</div><div class="lbl">${t('stat.memories')}</div></div>
      <div><div class="num">${s.compactions}</div><div class="lbl">${t('stat.compactions')}</div></div>
    </div></div></div>`).join('');
}

/* ---- Config ---- */
let cfgData = {};
async function loadConfig() {
  const data = await api('/api/config');
  if (!data) return;
  cfgData = data;
  S.cfgOriginal = JSON.stringify(data);
  S.cfgDirty = false;
  $('btn-cfg-save').disabled = true;
  renderConfig(data);
}

function cfgSelect(key, val, options) {
  return `<div class="cfg-row"><div class="cfg-label"><code>${escHtml(key)}</code> <span class="tip-icon" data-tip="tip.${escAttr(key)}">?</span></div>
  <div class="cfg-input"><select data-cfg="${escAttr(key)}">${options.map(o => `<option value="${escAttr(o.value)}" ${o.value === val ? 'selected' : ''}>${escHtml(o.label)}</option>`).join('')}</select></div></div>`;
}
function cfgText(key, val) {
  return `<div class="cfg-row"><div class="cfg-label"><code>${escHtml(key)}</code> <span class="tip-icon" data-tip="tip.${escAttr(key)}">?</span></div>
  <div class="cfg-input"><input type="text" data-cfg="${escAttr(key)}" value="${escAttr(val)}" style="width:300px"></div></div>`;
}

function renderConfig(c) {
  const cw = c.categoryWeights || {};
  $('config-sections').innerHTML = `
  <div class="config-section"><h3>${t('config.extraction')}</h3>
    ${cfgSelect('extractionMode', c.extractionMode || 'rules', [
      { value: 'rules', label: t('config.modeRules') },
      { value: 'llm', label: t('config.modeLlm') },
      { value: 'hybrid', label: t('config.modeHybrid') },
    ])}
    ${cfgText('llmModel', c.llmModel || 'claude-opus-4-6')}
    ${cfgNum('llmMaxTranscriptChars', c.llmMaxTranscriptChars || 12000, 1000, 50000)}
  </div>
  <div class="config-section"><h3>${t('config.memMgmt')}</h3>
    ${cfgNum('maxMemoriesPerProject', c.maxMemoriesPerProject, 1, 50000)}
    ${cfgNum('maxRestoreTokens', c.maxRestoreTokens, 100, 100000)}
    ${cfgNum('maxMemoriesPerRestore', c.maxMemoriesPerRestore, 1, 200)}
    ${cfgNum('maxPromptRecallResults', c.maxPromptRecallResults, 1, 50)}
  </div>
  <div class="config-section"><h3>${t('config.decayPrune')}</h3>
    ${cfgRange('decayFactor', c.decayFactor, 0, 1, 0.01)}
    ${cfgRange('pruneThreshold', c.pruneThreshold, 0, 1, 0.01)}
    ${cfgRange('scoreFloor', c.scoreFloor, 0, 1, 0.01)}
    ${cfgNum('decayIntervalDays', c.decayIntervalDays, 1, 365)}
  </div>
  <div class="config-section"><h3>${t('config.catWeights')}</h3>
    ${['architecture','decision','error','finding','file_change','note'].map(k =>
      cfgRange('categoryWeights.' + k, cw[k] !== undefined ? cw[k] : 0.5, 0, 1, 0.05, t('cat.'+k))
    ).join('')}
  </div>`;

  // Bind change handlers
  $('config-sections').querySelectorAll('input, select').forEach(inp => {
    inp.addEventListener(inp.tagName === 'SELECT' ? 'change' : 'input', () => onCfgChange(inp));
  });
}

function cfgNum(key, val, min, max) {
  return `<div class="cfg-row"><div class="cfg-label"><code>${escHtml(key.split('.').pop())}</code> <span class="tip-icon" data-tip="tip.${key.split('.').pop()}">?</span></div>
  <div class="cfg-input"><input type="number" data-cfg="${escAttr(key)}" value="${val}" min="${min}" max="${max}"></div></div>`;
}
function cfgRange(key, val, min, max, step, label) {
  const name = label || key.split('.').pop();
  return `<div class="cfg-row"><div class="cfg-label"><code>${escHtml(name)}</code> <span class="tip-icon" data-tip="tip.${key.split('.').pop()}">?</span></div>
  <div class="cfg-input"><input type="range" data-cfg="${escAttr(key)}" value="${val}" min="${min}" max="${max}" step="${step}">
  <input type="number" data-cfg-mirror="${escAttr(key)}" value="${val}" min="${min}" max="${max}" step="${step}" style="width:70px">
  </div></div>`;
}

function onCfgChange(inp) {
  const key = inp.dataset.cfg || inp.dataset.cfgMirror;
  if (!key) return;
  // Sync range <-> number
  if (inp.dataset.cfg) {
    const mirror = $('config-sections').querySelector('[data-cfg-mirror="' + key + '"]');
    if (mirror) mirror.value = inp.value;
  } else {
    const main = $('config-sections').querySelector('[data-cfg="' + key + '"]');
    if (main) main.value = inp.value;
  }
  S.cfgDirty = true;
  $('btn-cfg-save').disabled = false;
}

$('btn-cfg-save').onclick = async () => {
  const updates = {};
  $('config-sections').querySelectorAll('[data-cfg]').forEach(inp => {
    const key = inp.dataset.cfg;
    const raw = inp.value;
    const val = (inp.type === 'number' || inp.type === 'range') ? parseFloat(raw) : raw;
    if (key.startsWith('categoryWeights.')) {
      if (!updates.categoryWeights) updates.categoryWeights = {};
      updates.categoryWeights[key.split('.')[1]] = val;
    } else {
      updates[key] = val;
    }
  });
  const res = await api('/api/config', { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(updates) });
  if (res) { toast(t('config.saved'), 'success'); S.cfgDirty = false; $('btn-cfg-save').disabled = true; cfgData = res; S.cfgOriginal = JSON.stringify(res); }
};

$('btn-cfg-reset').onclick = () => {
  confirm_(t('confirm.resetTitle'), t('confirm.resetMsg'), async () => {
    const res = await api('/api/config', { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({reset:true}) });
    if (res) { toast(t('config.resetDone'), 'success'); cfgData = res; renderConfig(res); S.cfgDirty = false; $('btn-cfg-save').disabled = true; }
  });
};

$('btn-prune').onclick = async () => {
  const preview = await api('/api/prune/preview');
  if (!preview) return;
  confirm_(t('config.runPrune'), t('config.previewPrune', { belowScore: preview.belowScore, old: preview.old }), async () => {
    const res = await api('/api/prune', { method:'POST', headers:{'Content-Type':'application/json'}, body:'{}' });
    if (res) { toast(t('config.pruned') + ' ' + res.pruned + ' ' + t('stat.memories'), 'success'); loadOverview(); }
  });
};

$('btn-prune-old').onclick = async () => {
  const preview = await api('/api/prune/preview?days=30');
  if (!preview) return;
  confirm_(t('config.pruneOld'), t('config.previewPrune', { belowScore: 0, old: preview.old }), async () => {
    const res = await api('/api/prune', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({olderThan:30}) });
    if (res) { toast(t('config.pruned') + ' ' + res.pruned + ' ' + t('stat.memories'), 'success'); loadOverview(); }
  });
};

/* ---- Onboarding ---- */
$('btn-onboard-dismiss').onclick = () => { $('onboard-overlay').classList.remove('show'); localStorage.setItem('ic-onboard-done', '1'); };

/* ---- Init ---- */
document.querySelectorAll('.lang-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    S.lang = btn.dataset.lang;
    localStorage.setItem('ic-lang', S.lang);
    applyI18n();
    const pg = location.hash.slice(1) || 'overview';
    navigate(pg);
  });
});

document.querySelectorAll('.nav-item').forEach(item => {
  item.addEventListener('click', () => navigate(item.dataset.page));
});

window.addEventListener('hashchange', () => {
  const pg = location.hash.slice(1) || 'overview';
  navigate(pg);
});

applyI18n();
api('/api/config').then(data => { if (data) cfgData = data; });
const initPage = location.hash.slice(1) || 'overview';
navigate(initPage);
loadProjects(); // populate dropdown

// Auto-refresh overview every 30s
setInterval(() => {
  if ($('page-overview').classList.contains('active')) loadOverview();
}, 30000);
</script>
</body>
</html>
